<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      background: #f4f6f8;
      display: flex;
      overflow-x: auto;
    }

    .sidebar {
      width: 230px;
      background: #1a73e8;
      color: white;
      padding: 20px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      overflow-y: auto;
    }

    .sidebar h2 {
      font-size: 20px;
      margin-bottom: 30px;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
    }

    .sidebar li {
      margin: 12px 0;
    }

    .sidebar a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 10px;
      border-radius: 6px;
      transition: background 0.2s, padding-left 0.2s;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background: rgba(255, 255, 255, 0.15);
      padding-left: 16px;
    }

    .main {
      margin-left: 230px;
      padding: 30px;
      width: calc(100% - 230px);
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .header h1 {
      font-size: 24px;
      color: #333;
    }

    .add-btn {
      background: #2563eb;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      white-space: nowrap;
    }

    .add-btn:hover {
      background: #1e40af;
    }

    .search {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .search input,
    .search select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      white-space: nowrap;
    }

    .table-wrapper {
      overflow-x: auto;
      width: 100%;
    }

    table {
      min-width: 1200px;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      font-size: 14px;
      white-space: nowrap;
    }

    th, td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f9fafb;
      font-weight: 600;
    }

    .product-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .product-info img {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
      flex-shrink: 0;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: bold;
      display: inline-block;
    }

    .status-in {
      background: #dcfce7;
      color: #166534;
    }

    .status-low {
      background: #fef3c7;
      color: #92400e;
    }

    .status-out {
      background: #fee2e2;
      color: #991b1b;
    }

    .color-tag {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 4px;
      border: 1px solid #ccc;
    }

    .view-btn, .edit-btn, .delete-btn {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      color: white;
      white-space: nowrap;
    }

    .view-btn { background: #0ea5e9; }
    .edit-btn { background: #28a745; }
    .delete-btn { background: #dc3545; }

    .view-btn:hover { background: #0284c7; }
    .edit-btn:hover { background: #218838; }
    .delete-btn:hover { background: #b02a37; }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }

      .main {
        margin-left: 0;
        padding: 20px;
        width: 100%;
      }

      .sidebar {
        position: static;
        width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <h2 id="storeTitle">Your Store</h2>
    <ul>
      <li><a href="home.html"><i class="fas fa-home"></i> Home</a></li>
      <li><a href="orders.html"><i class="fas fa-shopping-cart"></i> Orders</a></li>
      <li><a href="products.html"><i class="fas fa-box"></i> Products</a></li>
      <li><a href="inventory.html" class="active"><i class="fas fa-warehouse"></i> Inventory</a></li>
      <li><a href="collections.html"><i class="fas fa-th"></i> Collections</a></li>
      <li><a href="customers.html"><i class="fas fa-users"></i> Customers</a></li>
      <li><a href="content.html"><i class="fas fa-file-alt"></i> Content</a></li>
      <li><a href="marketing.html"><i class="fas fa-bullhorn"></i> Marketing</a></li>
      <li><a href="themes.html"><i class="fas fa-palette"></i> Store Themes</a></li>
      <li><a href="markets.html"><i class="fas fa-globe"></i> Markets</a></li>
      <li><a href="analytics.html"><i class="fas fa-chart-line"></i> Analytics</a></li>
      <li><a href="discounts.html"><i class="fas fa-tags"></i> Discounts</a></li>
      <li><a href="sales-channels.html"><i class="fas fa-store"></i> Sales Channels</a></li>
    </ul>
    <ul style="margin-top: 30px;">
      <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
      <li><a href="logout.html"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
  </div>

  <!-- Main Inventory Content -->
  <div class="main">
    <div class="header">
      <h1>Inventory</h1>
      <a href="add-product.html" class="add-btn"><i class="fas fa-plus"></i> Add Inventory</a>
    </div>

    <div class="search">
      <input type="text" placeholder="Search inventory..." id="searchInput">
      <select id="statusFilter">
        <option value="all">All</option>
        <option value="in">In Stock</option>
        <option value="low">Low Stock</option>
        <option value="out">Out of Stock</option>
      </select>
    </div>

    <table id="inventoryTable">
      <thead>
        <tr>
          <th>Product</th>
          <th>Colors</th>
          <th>SKU</th>
          <th>Available</th>
          <th>On Hand</th>
          <th>Status</th>
          <th>Locations</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="inventoryBody"></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div class="modal" id="viewModal">
    <div class="modal-content" id="modalContent"></div>
  </div>

  <script>
    const store = localStorage.getItem("store_name");
    const storeTitle = document.getElementById("storeTitle");
    if (store && storeTitle) storeTitle.textContent = `${store} Store`;

    // âœ… Updated: use the same key as used in add-product.html
    const userEmail = localStorage.getItem("signup_email");

    async function loadInventory() {
      const res = await fetch(`/api/products?email=${encodeURIComponent(userEmail)}`);
      const allProducts = await res.json();
      const inventory = allProducts.filter(p => p.trackInventory);
      const tbody = document.getElementById("inventoryBody");
      tbody.innerHTML = "";

      inventory.forEach(item => {
        const statusClass = getStatusClass(item.availableQty);
        const statusText = getStatusText(item.availableQty);

        const row = document.createElement("tr");
        row.setAttribute("data-status", statusClass);
        row.innerHTML = `
          <td><div class="product-info">
            <img src="${item.media?.[0] || ''}" alt="" />
            <span>${item.title}</span>
          </div></td>
          <td>${(item.colors || []).map(c => `<span class="color-tag" style="background:${c}"></span>`).join('')}</td>
          <td>${item.sku || '-'}</td>
          <td>${item.availableQty || 0}</td>
          <td>${item.onHandQty || 0}</td>
          <td><span class="status-badge ${statusClass}">${statusText}</span></td>
          <td>${(item.inventoryLocations || []).join(', ')}</td>
          <td class="action-buttons">
  <button class="edit-btn" onclick="window.location.href='add-product.html?id=${item._id}'">Edit</button>
  <button class="delete-btn" onclick="deleteProduct('${item._id}')">Delete</button>
</td>

        `;
        tbody.appendChild(row);
      });
    }

    function getStatusClass(qty) {
      if (qty === 0) return "status-out";
      if (qty < 10) return "status-low";
      return "status-in";
    }

    function getStatusText(qty) {
      if (qty === 0) return "Out of Stock";
      if (qty < 10) return "Low Stock";
      return "In Stock";
    }

    async function viewDetails(id) {
      const res = await fetch(`/api/products/${id}?email=${encodeURIComponent(userEmail)}`);
      const product = await res.json();
      const modal = document.getElementById("viewModal");
      const modalContent = document.getElementById("modalContent");

      modalContent.innerHTML = `
        <h3>${product.title}</h3>
        <p><strong>Description:</strong> ${product.description}</p>
        <p><strong>SKU:</strong> ${product.sku}</p>
        <p><strong>Barcode:</strong> ${product.barcode}</p>
        <p><strong>Weight:</strong> ${product.weight} ${product.weightUnit}</p>
        <p><strong>Category:</strong> ${product.category} / ${product.subcategory}</p>
        <p><strong>Vendor:</strong> ${product.vendor}</p>
        <p><strong>Status:</strong> ${product.status}</p>
        <p><strong>Colors:</strong> ${(product.colors || []).map(c => `<span class='color-tag' style='background:${c}'></span>`).join(' ')}</p>
        <p><strong>Materials:</strong> ${(product.materials || []).join(', ')}</p>
        <p><strong>Sizes:</strong> ${(product.sizes || []).join(', ')}</p>
        <p><strong>Tags:</strong> ${(product.tags || []).join(', ')}</p>
        <p><strong>Inventory:</strong><br>${(product.inventoryLocations || []).join('<br>')}</p>
        <button onclick="document.getElementById('viewModal').style.display='none'">Close</button>
      `;

      modal.style.display = "flex";
    }

    function deleteProduct(id) {
      if (confirm("Are you sure you want to delete this product?")) {
        fetch(`/api/products/${id}?email=${encodeURIComponent(userEmail)}`, { method: "DELETE" })
          .then(() => loadInventory());
      }
    }

    document.getElementById("searchInput").addEventListener("input", applySearchAndFilter);
    document.getElementById("statusFilter").addEventListener("change", applySearchAndFilter);

    function applySearchAndFilter() {
      const searchValue = document.getElementById("searchInput").value.toLowerCase();
      const selectedStatus = document.getElementById("statusFilter").value;
      const tableRows = document.querySelectorAll("#inventoryTable tbody tr");

      tableRows.forEach(row => {
        const product = row.querySelector(".product-info span").textContent.toLowerCase();
        const sku = row.cells[2].textContent.toLowerCase();
        const rowStatus = row.getAttribute("data-status");

        const matchesSearch = product.includes(searchValue) || sku.includes(searchValue);
        const matchesStatus = selectedStatus === "all" || selectedStatus === rowStatus;

        row.style.display = matchesSearch && matchesStatus ? "" : "none";
      });
    }

    window.addEventListener("click", e => {
      if (e.target.id === "viewModal") document.getElementById("viewModal").style.display = "none";
    });

    loadInventory();
  </script>
</body>
</html>
