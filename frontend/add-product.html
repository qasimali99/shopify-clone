<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Add Product</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tiny.cloud/1/hao1w2wju24khcwvqslwjdjhdsdbn9tgfh9uxu904dxhgzxo/tinymce/6/tinymce.min.js"
    referrerpolicy="origin"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    body {
      padding: 20px;
      background: #f5f7fb;
    }

    h1 {
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
    }

    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .row {
      display: flex;
      gap: 20px;
    }

    .row .form-group {
      flex: 1;
    }

    .multi-select {
      height: auto;
    }

    .image-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    .image-preview img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    .tag-input {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      min-height: 46px;
      background: #fff;
    }

    .tag-input input {
      border: none;
      outline: none;
      flex: 1;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      background: #007bff;
      color: #fff;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 14px;
      position: relative;
      gap: 6px;
    }

    .tag span {
      margin-left: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    /* CSS: styles.css */
    .form-group {
      margin-bottom: 20px;
    }

    .multi-select {
      width: 180px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
      margin-right: 10px;
    }

    .color-row,
    .variant-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .add-btn {
      padding: 6px 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      height: 38px;
    }

    .add-btn:hover {
      background-color: #0056b3;
    }

    /* CSS: styles.css */
    #drop-area {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      margin-bottom: 20px;
      background: #fafafa;
    }

    #drop-area:hover {
      background-color: #f0f8ff;
    }

    #mediaPreview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #mediaPreview img,
    #mediaPreview video {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border: 1px solid #ccc;
      border-radius: 6px;
      position: relative;
    }

    .media-item {
      position: relative;
      display: inline-block;
    }

    .media-item button {
      position: absolute;
      top: 2px;
      right: 2px;
      background: red;
      border: none;
      color: white;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      width: 20px;
      height: 20px;
      line-height: 20px;
    }

    #color-list,
    #variant-list {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    button {
      padding: 10px 18px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    #size-list,
    #material-list,
    #color-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    #size-list .tag,
    #material-list .tag,
    #color-list .tag {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
      background-color: #007bff;
      color: white;
    }

    #locationList {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      /* Reduced gap between tags */
      margin-top: 6px;
      /* Reduced space above the list */
    }
  </style>
</head>

<body>
  <h1>Add Product</h1>
  <form id="editProductForm">
    <div class="form-group">
      <label>Product Name</label>
      <input type="text" placeholder="Enter product name" />
    </div>

    <div class="form-group">
      <label>Description</label>
      <textarea id="productDescription" placeholder="Product description..."></textarea>
    </div>

    <div class="row">
      <div class="form-group">
        <label>Original Price</label>
        <input type="number" placeholder="e.g. 2500" />
      </div>
      <div class="form-group">
        <label>Selling Price</label>
        <input type="number" placeholder="e.g. 1999" />
      </div>
      <div class="form-group">
        <label>Currency</label>
        <select>
          <option>PKR</option>
          <option>USD</option>
          <option>EUR</option>
          <option>INR</option>
          <option>AED</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>Categories</label>
      <select id="main-category">
        <option value="">Select Category</option>
        <option value="clothing">Clothing</option>
        <option value="electronics">Electronics</option>
        <option value="accessories">Accessories</option>
      </select>
    </div>

    <div class="form-group" id="subcategory-container" style="display:none;">
      <label>Product Type</label>
      <select id="subcategory"></select>
    </div>
    <!-- HTML: edit-product.html -->
    <div class="form-group">
      <label>Colors</label>
      <div id="color-section">
        <div class="color-row">
          <select class="multi-select color-select">
            <option value="">Select color</option>
            <option>Black</option>
            <option>White</option>
            <option>Red</option>
            <option>Blue</option>
            <option>Green</option>
            <option>Yellow</option>
            <option>Pink</option>
            <option>Purple</option>
            <option>Orange</option>
            <option>Grey</option>
          </select>
          <button type="button" class="add-btn" onclick="addColor()">Add Color</button>
        </div>
        <div id="color-list"></div>
      </div>
    </div>
    <div class="form-group">
      <label>Variants (Sizes)</label>
      <div id="variant-section">
        <div class="variant-row">
          <select class="multi-select variant-select">
            <option value="">Select size</option>
            <option>S</option>
            <option>M</option>
            <option>L</option>
            <option>XL</option>
            <option>2XL</option>
          </select>
          <button type="button" class="add-btn" onclick="addSize()">Add Size</button>
        </div>
        <div id="size-list"></div>
      </div>
    </div>

    <div class="form-group">
      <label>Material</label>
      <div class="variant-row">
        <select class="multi-select material-select">
          <option value="">Select material</option>
          <option>Cotton</option>
          <option>Mesh</option>
          <option>Polyster</option>
          <option>Dri-Fit</option>
          <option>Fleece</option>
        </select>
        <button type="button" class="add-btn" onclick="addMaterial()">Add Material</button>
      </div>
      <div id="material-list"></div>
    </div>

    <div class="form-group">
      <label for="mediaUpload">Upload Images & Videos</label>
      <div id="drop-area">
        <p>Drag & drop media here or click to upload</p>
        <input type="file" id="mediaUpload" accept="image/*,video/*" multiple />
      </div>
      <div id="mediaPreview"></div>
    </div>

    <div class="row">
      <div class="form-group">
        <label>Vendor</label>
        <input type="text" id="vendor" placeholder="Enter vendor name" />
      </div>

      <div class="form-group">
        <label>Status</label>
        <select id="status">
          <option value="Active">Active</option>
          <option value="Draft">Draft</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>Tags</label>
      <div class="tag-input" id="tagInput">
        <input type="text" id="tagTextBox" placeholder="Type and press enter...">
      </div>
    </div>
    <!-- Inventory Section -->
    <div class="form-group">
      <label><input type="checkbox" id="trackInventory"> Track Inventory</label>
    </div>

    <div class="row" style="margin-bottom: 10px;"></div>
    <div id="inventoryDetails" style="display: none;">
      <div class="form-group">
        <label><input type="checkbox" id="allowOOS"> Continue selling when out of stock</label>
      </div>
      <div class="form-group">
        <label>Inventory by Location</label>
        <div id="inventoryTable">
          <div class="row">
            <div class="form-group">
              <input type="text" placeholder="Location (e.g. Warehouse)" class="location-name" />
            </div>
            <div class="form-group">
              <input type="number" placeholder="Quantity" class="location-qty" />
            </div>
            <button type="button" class="add-btn" onclick="addLocation()">Add Location</button>
          </div>
          <!-- Container where location tags will be appended -->
          <div id="locationList"></div>
        </div>
      </div>

      <div class="row" style="margin-bottom: 10px;">
        <div class="form-group">
          <label>Barcode</label>
          <input type="text" placeholder="Enter barcode" />
        </div>
        <div class="form-group">
          <label>SKU</label>
          <input type="text" placeholder="Enter SKU" />
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label>Product Weight</label>
          <input type="number" id="productWeight" placeholder="e.g. 500" />
        </div>
        <div class="form-group">
          <label>Weight Unit</label>
          <select id="weightUnit">
            <option>Grams</option>
            <option>Kilograms</option>
            <option>Milligrams</option>
            <option>Liters</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label>Available Quantity</label>
          <input type="number" id="availableQty" placeholder="e.g. 120" />
        </div>
        <div class="form-group">
          <label>On-Hand Quantity</label>
          <input type="number" id="onHandQty" placeholder="e.g. 100" />
        </div>
      </div>

      <button type="submit">Save Product</button>
  </form>

  <script>
    const categoryMap = {
      clothing: ["T-Shirts", "Hoodies", "Jackets", "Trousers"],
      electronics: ["Mobiles", "Laptops", "Headphones"],
      accessories: ["Watches", "Bags", "Belts"]
    };

    document.getElementById('main-category').addEventListener('change', function () {
      const sub = document.getElementById('subcategory');
      const container = document.getElementById('subcategory-container');
      sub.innerHTML = '';
      const selected = this.value;
      if (categoryMap[selected]) {
        container.style.display = 'block';
        categoryMap[selected].forEach(item => {
          const opt = document.createElement('option');
          opt.textContent = item;
          sub.appendChild(opt);
        });
      } else {
        container.style.display = 'none';
      }
    });

    const tagInput = document.getElementById('tagInput');
    const tagTextBox = document.getElementById('tagTextBox');
    tagTextBox.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const value = tagTextBox.value.trim();
        if (!value) return;
        const tag = document.createElement('span');
        tag.className = 'tag';
        tag.dataset.value = value;
        tag.textContent = value;
        tagInput.insertBefore(tag, tagTextBox);
        tagTextBox.value = '';
      }
    });

    const dropArea = document.getElementById("drop-area");
    const input = document.getElementById("mediaUpload");
    const preview = document.getElementById("mediaPreview");

    function handleFiles(files) {
      Array.from(files).forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const wrapper = document.createElement("div");
          wrapper.classList.add("media-item");

          let element;
          if (file.type.startsWith("image")) {
            element = document.createElement("img");
            element.src = e.target.result;
          } else if (file.type.startsWith("video")) {
            element = document.createElement("video");
            element.src = e.target.result;
            element.controls = true;
          }

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "×";
          deleteBtn.onclick = () => wrapper.remove();

          wrapper.appendChild(element);
          wrapper.appendChild(deleteBtn);
          preview.appendChild(wrapper);
        };
        reader.readAsDataURL(file);
      });
    }

    input.addEventListener("change", e => {
      handleFiles(e.target.files);
    });

    dropArea.addEventListener("dragover", e => {
      e.preventDefault();
      dropArea.classList.add("highlight");
    });

    dropArea.addEventListener("dragleave", () => {
      dropArea.classList.remove("highlight");
    });

    dropArea.addEventListener("drop", e => {
      e.preventDefault();
      dropArea.classList.remove("highlight");
      handleFiles(e.dataTransfer.files);
    });

    dropArea.addEventListener("click", () => {
      input.click();
    });

    function createTag(value, listId) {
      const list = document.getElementById(listId);
      if (
        value &&
        !Array.from(list.children).some(el => el.dataset.value === value)
      ) {
        const tag = document.createElement("div");
        tag.className = "tag";
        tag.dataset.value = value;
        tag.textContent = value;

        const delBtn = document.createElement("span");
        delBtn.textContent = "×";
        delBtn.onclick = () => tag.remove();

        tag.appendChild(delBtn);
        list.appendChild(tag);
      }
    }

    function addColor() {
      const val = document.querySelector(".color-select").value;
      if (!val) return;
      const tag = document.createElement("div");
      tag.className = "tag";
      tag.dataset.value = val;
      tag.textContent = val;
      tag.style.backgroundColor = val.toLowerCase();
      if (["white", "yellow", "pink"].includes(val.toLowerCase())) {
        tag.style.color = "#000";
        tag.style.border = "1px solid #ccc";
      } else {
        tag.style.color = "#fff";
      }
      const delBtn = document.createElement("span");
      delBtn.textContent = " ×";
      delBtn.style.cursor = "pointer";
      delBtn.style.marginLeft = "8px";
      delBtn.style.fontWeight = "bold";
      delBtn.onclick = () => tag.remove();
      tag.appendChild(delBtn);
      document.getElementById("color-list").appendChild(tag);
    }

    function addSize() {
      const val = document.querySelector(".variant-select").value;
      createTag(val, "size-list");
    }

    function addMaterial() {
      const val = document.querySelector(".material-select").value;
      createTag(val, "material-list");
    }

    document.getElementById("trackInventory").addEventListener("change", function () {
      document.getElementById("inventoryDetails").style.display = this.checked ? "block" : "none";
    });

    function addLocation() {
      const locationName = document.querySelector(".location-name").value.trim();
      const locationQty = document.querySelector(".location-qty").value.trim();

      // Validate location and quantity
      if (locationName && locationQty && !isNaN(locationQty)) {
        const locationList = document.getElementById("locationList");

        // Create a new tag for the location and quantity
        const entry = document.createElement("div");
        entry.className = "tag";
        entry.textContent = `${locationName} - ${locationQty} pcs`;

        // Add delete button to remove the location
        const delBtn = document.createElement("span");
        delBtn.textContent = " ×";
        delBtn.style.marginLeft = "10px";
        delBtn.style.cursor = "pointer";
        delBtn.style.fontWeight = "bold";
        delBtn.onclick = () => entry.remove();

        // Append delete button and location entry to the list
        entry.appendChild(delBtn);
        locationList.appendChild(entry);

        // Clear the input fields for location and quantity
        document.querySelector(".location-name").value = "";
        document.querySelector(".location-qty").value = "";
      } else {
        alert("Please provide both location and quantity.");
      }
    }

    tinymce.init({
      selector: '#productDescription',
      plugins: 'image media link code lists table advlist',
      toolbar: 'undo redo | blocks | bold italic underline | alignleft aligncenter alignright | bullist numlist | image media link | code',
      height: 300,
      branding: false
    });

  const urlParams = new URLSearchParams(window.location.search);
  const productId = urlParams.get("id"); // detect edit mode

       document.addEventListener("DOMContentLoaded", async function () {
    if (productId) {
      try {
        const email = localStorage.getItem("signup_email");
        const res = await fetch(`/api/products/${productId}?email=${email}`);
        const data = await res.json();

        if (data && data.title) {
          document.querySelector('input[placeholder="Enter product name"]').value = data.title;
          tinymce.get("productDescription").setContent(data.description || "");
          document.querySelectorAll('input[type="number"]')[0].value = data.originalPrice || 0;
          document.querySelectorAll('input[type="number"]')[1].value = data.sellingPrice || 0;
          document.querySelectorAll("select")[0].value = data.currency || "";
          document.getElementById("main-category").value = data.category || "";

          // Populate subcategory
          const sub = document.getElementById("subcategory");
          const container = document.getElementById("subcategory-container");
          const categoryMap = {
            clothing: ["T-Shirts", "Hoodies", "Jackets", "Trousers"],
            electronics: ["Mobiles", "Laptops", "Headphones"],
            accessories: ["Watches", "Bags", "Belts"]
          };
          if (categoryMap[data.category]) {
            container.style.display = 'block';
            sub.innerHTML = '';
            categoryMap[data.category].forEach(item => {
              const opt = document.createElement('option');
              opt.textContent = item;
              sub.appendChild(opt);
            });
            document.getElementById("subcategory").value = data.subcategory || "";
          }

          data.colors?.forEach(c => createTag(c, "color-list"));
          data.sizes?.forEach(s => createTag(s, "size-list"));
          data.materials?.forEach(m => createTag(m, "material-list"));
          data.tags?.forEach(t => createTag(t, "tagInput"));

          document.getElementById("trackInventory").checked = data.trackInventory || false;
          document.getElementById("inventoryDetails").style.display = data.trackInventory ? "block" : "none";
          document.getElementById("allowOOS").checked = data.allowOOS || false;
          document.querySelector('input[placeholder="Enter barcode"]').value = data.barcode || "";
          document.querySelector('input[placeholder="Enter SKU"]').value = data.sku || "";
          document.getElementById("productWeight").value = data.weight || 0;
          document.querySelectorAll("select")[2].value = data.weightUnit || "";
          document.getElementById("availableQty").value = data.availableQty || 0;
          document.getElementById("onHandQty").value = data.onHandQty || 0;

          data.inventoryLocations?.forEach(loc => createTag(loc, "locationList"));

          data.media?.forEach(url => {
            const wrapper = document.createElement("div");
            wrapper.classList.add("media-item");

            let element;
            if (url.includes(".mp4") || url.includes("video")) {
              element = document.createElement("video");
              element.src = url;
              element.controls = true;
            } else {
              element = document.createElement("img");
              element.src = url;
            }

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "×";
            deleteBtn.onclick = () => wrapper.remove();

            wrapper.appendChild(element);
            wrapper.appendChild(deleteBtn);
            document.getElementById("mediaPreview").appendChild(wrapper);
          });

          document.getElementById("vendor").value = data.vendor || "";
          document.getElementById("status").value = data.status || "";
        }
      } catch (err) {
        console.error("Failed to fetch product:", err);
      }
    }
    document.getElementById("editProductForm").addEventListener("keydown", function (e) {
    const tag = e.target.tagName.toLowerCase();
    if (e.key === "Enter" && tag !== "textarea") {
      e.preventDefault();
    }
  });

      document.getElementById("editProductForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const getTagValues = (containerId) => {
          return Array.from(document.querySelectorAll(`#${containerId} .tag`)).map(tag => tag.dataset.value || tag.textContent.replace(" ×", "").trim());
        };

        const productData = {
          title: document.querySelector('input[placeholder="Enter product name"]').value,
          description: tinymce.get("productDescription").getContent(),
          originalPrice: +document.querySelectorAll('input[type="number"]')[0]?.value || 0,
          sellingPrice: +document.querySelectorAll('input[type="number"]')[1]?.value || 0,
          currency: document.querySelectorAll("select")[0]?.value || "",
          category: document.getElementById("main-category").value,
          subcategory: document.getElementById("subcategory").value,
          colors: getTagValues("color-list"),
          sizes: getTagValues("size-list"),
          materials: getTagValues("material-list"),
          tags: getTagValues("tagInput"),
          trackInventory: document.getElementById("trackInventory").checked,
          allowOOS: document.getElementById("allowOOS").checked,
          barcode: document.querySelector('input[placeholder="Enter barcode"]').value,
          sku: document.querySelector('input[placeholder="Enter SKU"]').value,
          weight: +document.getElementById('productWeight').value || 0,
          weightUnit: document.querySelectorAll("select")[2]?.value || "",
          availableQty: +document.getElementById('availableQty').value || 0,
          onHandQty: +document.getElementById('onHandQty').value || 0,

          inventoryLocations: getTagValues("locationList"),
          media: Array.from(document.querySelectorAll("#mediaPreview img, #mediaPreview video"))
            .map(el => el.src),

            
          // Added fields for vendor and status
          vendor: document.getElementById("vendor").value,
          status: document.getElementById("status").value,

          userEmail: localStorage.getItem("signup_email"),

        };

        try {
         const email = localStorage.getItem("signup_email");
const url = productId ? `/api/products/${productId}?email=${email}` : "/api/products";
const method = productId ? "PUT" : "POST";

const res = await fetch(url, {
  method,
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(productData),
});

          if (res.ok) {
            window.location.href = "products.html";
          } else {
            alert("Error saving product.");
          }
        } catch (err) {
          console.error(err);
          alert("Server error while saving product.");
        }
      });
    });
  
  </script>
</body>

</html>