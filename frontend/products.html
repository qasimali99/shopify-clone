<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>All Products</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    html, body {
      overflow-x: auto;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', sans-serif;
    }

    body {
      background: #f4f6f8;
      display: flex;
    }

    .sidebar {
      width: 230px;
      background: #1a73e8;
      color: white;
      padding: 20px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      overflow-y: auto;
    }

    .sidebar h2 {
      font-size: 20px;
      margin-bottom: 30px;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
    }

    .sidebar li {
      margin: 12px 0;
    }

    .sidebar a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 10px;
      border-radius: 6px;
      transition: background 0.2s, padding-left 0.2s;
    }

    .sidebar a:hover,
    .sidebar a.active {
      background: rgba(255, 255, 255, 0.15);
      padding-left: 16px;
    }

    .main-content {
      margin-left: 230px;
      padding: 20px;
      flex: 1;
    }

    h1 {
      margin-bottom: 10px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .top-bar .actions {
      display: flex;
      gap: 10px;
    }

    .top-bar input[type="text"],
    select {
      padding: 8px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .top-bar button {
      background: #007bff;
      color: #fff;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .table-wrapper {
      overflow-x: auto;
      width: 100%;
    }

    table {
      min-width: 1200px;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      width: 100%;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #eaeaea;
      white-space: nowrap;
    }

    th {
      background: #007bff;
      color: white;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 13px;
      color: white;
      display: inline-block;
    }

    .in-stock {
      background-color: #28a745;
    }

    .low-stock {
      background-color: #ffc107;
      color: #000;
    }

    .out-stock {
      background-color: #dc3545;
    }

    .draft {
      background-color: #6c757d;
    }

    .active {
      background-color: #007bff;
    }

    .actions button {
      padding: 6px 10px;
      margin-right: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      color: white;
    }

    .edit-btn {
      background-color: #28a745;
    }

    .edit-btn:hover {
      background: #218838;
    }

    .delete-btn {
      background-color: #dc3545;
    }

    .delete-btn:hover {
      background: #b02a37;
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }

      .main-content {
        margin-left: 0;
        padding: 10px;
      }

      .sidebar {
        position: static;
        height: auto;
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <div class="sidebar" id="sidebar">
    <h2 id="storeTitle">Your Store</h2>
    <ul>
      <li><a href="home.html"><i class="fas fa-home"></i> Home</a></li>
      <li><a href="orders.html"><i class="fas fa-shopping-cart"></i> Orders</a></li>
      <li><a href="products.html" class="active"><i class="fas fa-box"></i> Products</a></li>
      <li><a href="inventory.html"><i class="fas fa-warehouse"></i> Inventory</a></li>
      <li><a href="collections.html"><i class="fas fa-th"></i> Collections</a></li>
      <li><a href="customers.html"><i class="fas fa-users"></i> Customers</a></li>
      <li><a href="content.html"><i class="fas fa-file-alt"></i> Content</a></li>
      <li><a href="marketing.html"><i class="fas fa-bullhorn"></i> Marketing</a></li>
      <li><a href="themes.html"><i class="fas fa-palette"></i> Store Themes</a></li>
      <li><a href="markets.html"><i class="fas fa-globe"></i> Markets</a></li>
      <li><a href="analytics.html"><i class="fas fa-chart-line"></i> Analytics</a></li>
      <li><a href="discounts.html"><i class="fas fa-tags"></i> Discounts</a></li>
      <li><a href="sales-channels.html"><i class="fas fa-store"></i> Sales Channels</a></li>
    </ul>
    <ul style="margin-top: 30px;">
      <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
      <li><a href="logout.html"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
    </ul>
  </div>

  <div class="main-content">
    <h1>All Products</h1>
    <div class="top-bar">
      <input type="text" id="searchInput" placeholder="Search by name or vendor..." />
      <div class="actions">
        <select id="stockFilter">
          <option value="all">All Stock</option>
          <option value="in">In Stock</option>
          <option value="low">Low Stock (≤10)</option>
          <option value="out">Out of Stock</option>
        </select>
        <select id="statusFilter">
          <option value="all">All Status</option>
          <option value="Active">Active</option>
          <option value="Draft">Draft</option>
        </select>
        <button onclick="window.location.href='add-product.html'">
          <i class="fas fa-plus"></i> Add Product
        </button>
      </div>
    </div>

    <table id="productsTable">
      <thead>
        <tr>
          <th>Image</th>
          <th>Name</th>
          <th>Stock</th>
          <th>Stock Status</th>
          <th>Vendor</th>
          <th>Price</th>
          <th>Category</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <!-- Custom Delete Confirmation Modal -->
  <div id="deleteModal" style="display: none; position: fixed; top: 0; left: 0; 
  width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); 
  align-items: center; justify-content: center; z-index: 9999;">
    <div
      style="background: white; padding: 20px 30px; border-radius: 10px; width: 320px; max-width: 90%; text-align: center;">
      <h3 style="margin-bottom: 15px;">Are you sure?</h3>
      <p>This product will be permanently deleted.</p>
      <div style="margin-top: 20px; display: flex; justify-content: space-between;">
        <button id="confirmDeleteBtn"
          style="background: #dc3545; border: none; padding: 8px 16px; border-radius: 5px; color: white; cursor: pointer;">Yes,
          Delete</button>
        <button id="cancelDeleteBtn"
          style="background: #6c757d; border: none; padding: 8px 16px; border-radius: 5px; color: white; cursor: pointer;">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const store = localStorage.getItem("store_name");
    const storeTitle = document.getElementById("storeTitle");
    if (store && storeTitle) storeTitle.textContent = `${store} Store`;

    function toggleContentMenu() {
      const submenu = document.getElementById("contentSubMenu");
      submenu.style.display = submenu.style.display === "none" ? "block" : "none";
    }

    let allProducts = [];

    async function fetchProducts() {
  try {
    const email = localStorage.getItem("signup_email");
    const res = await fetch(`/api/products?email=${encodeURIComponent(email)}`);
    allProducts = await res.json();
    renderProducts(allProducts);
  } catch (err) {
    console.error("Failed to fetch products:", err);
    alert("Error loading products.");
  }
}

    function renderProducts(products) {
      const tbody = document.querySelector("#productsTable tbody");
      tbody.innerHTML = "";

      products.forEach(product => {
        const tr = document.createElement("tr");
        const imgSrc = product.media?.[0] || "https://via.placeholder.com/60";
        const stockQty = product.onHandQty || 0;

        let stockClass = "in-stock";
        let stockStatus = "In Stock";
        if (stockQty <= 0) {
          stockStatus = "Out of Stock";
          stockClass = "out-stock";
        } else if (stockQty <= 10) {
          stockStatus = "Low Stock";
          stockClass = "low-stock";
        }

        const statusClass = product.status === "Active" ? 'active' : 'draft';

        tr.innerHTML = `
          <td><img src="${imgSrc}" alt="Product Image"></td>
          <td>${product.title || 'N/A'}</td>
          <td>${stockQty}</td>
          <td><span class="status-badge ${stockClass}">${stockStatus}</span></td>
          <td>${product.vendor || 'N/A'}</td>
          <td>${product.currency || 'PKR'} ${product.sellingPrice || 0}</td>
          <td>${product.category || '-'}</td>
          <td><span class="status-badge ${statusClass}">${product.status || 'Draft'}</span></td>
          <td class="actions">
            <button class="edit-btn" onclick="editProduct('${product._id}')">Edit</button>
<button class="delete-btn" onclick="deleteProduct('${product._id}')">Delete</button>

          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function applyFilters() {
      const search = document.getElementById("searchInput").value.toLowerCase();
      const stockFilter = document.getElementById("stockFilter").value;
      const statusFilter = document.getElementById("statusFilter").value;

      let filtered = allProducts.filter(p => {
        const matchesSearch = p.title?.toLowerCase().includes(search) || p.vendor?.toLowerCase().includes(search);
        let matchesStock = true;
        const qty = p.onHandQty || 0;
        if (stockFilter === "in") matchesStock = qty > 10;
        else if (stockFilter === "low") matchesStock = qty > 0 && qty <= 10;
        else if (stockFilter === "out") matchesStock = qty <= 0;

        const matchesStatus = statusFilter === "all" || p.status === statusFilter;

        return matchesSearch && matchesStock && matchesStatus;
      });

      renderProducts(filtered);
    }

    function editProduct(id) {
      window.location.href = `add-product.html?id=${id}`;

    }
    let deleteId = null;

    function deleteProduct(id) {
      deleteId = id;
      document.getElementById("deleteModal").style.display = "flex";
    }

    document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
  try {
    const userEmail = localStorage.getItem("signup_email");
const res = await fetch(`/api/products/${deleteId}?email=${encodeURIComponent(userEmail)}`, {
  method: "DELETE"
});


    const data = await res.json(); // 👈 always parse response

    if (res.ok && data.success) {
      fetchProducts(); // ✅ Refresh table
    } else {
      alert(data.message || "Failed to delete product."); // 👈 Better error
    }
  } catch (err) {
    console.error("❌ Delete Error:", err);
    alert("Server error while deleting.");
  } finally {
    document.getElementById("deleteModal").style.display = "none";
    deleteId = null;
  }
});


    document.getElementById("searchInput").addEventListener("input", applyFilters);
    document.getElementById("stockFilter").addEventListener("change", applyFilters);
    document.getElementById("statusFilter").addEventListener("change", applyFilters);
    document.addEventListener("DOMContentLoaded", fetchProducts);
  </script>
</body>
</html>